@model System.Data.DataTable

@{
    ViewBag.Title = "Report Preview";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
    table.dataTable {
        width: 100%;
        border-collapse: collapse;
    }

        table.dataTable th,
        table.dataTable td {
            padding: 6px;
            white-space: nowrap;
            border: 1px solid #ddd;
        }

        table.dataTable thead th {
            background: #e6e6e6;
            color: #333;
            text-align: center;
            font-weight: 600;
        }

    .text-left {
        text-align: left !important;
    }

    .text-right {
        text-align: right !important;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .export-btn {
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 6px;
    }

    .excel-btn {
        border: 1px solid #4caf50;
        color: #2e7d32;
    }

    .pdf-btn {
        border: 1px solid #e53935;
        color: #b71c1c;
    }

    .print-btn {
        border: 1px solid #424242;
        color: #424242;
    }
</style>

<div class="card shadow border border-danger p-3 mt-4">
    <div id="loadingSpinner" class="text-center p-5">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-danger"></i>
        <p class="mt-2 fw-semibold">Loading report, please wait...</p>
    </div>
    <div class="preview-header">
        <div>
            <h4 class="mb-1">Report Preview</h4>
            <p class="text-muted mb-0">Report results</p>
        </div>


        <a href="@Url.Action("Index", "Reports")" class="btn btn-outline-danger">
            ← Back
        </a>
    </div>
    @*<div id="loadingSpinner" class="text-center p-5">
            <i class="fa-solid fa-spinner fa-spin fa-3x text-danger"></i>
            <p class="mt-2 fw-semibold">Loading report, please wait...</p>
        </div>*@
    <div id="tableContainer" style="display:none;">

        <table id="previewTable" class="display nowrap">
            <thead>
                <tr>
                    @foreach (System.Data.DataColumn col in Model.Columns)
                    {
                        <th>@col.ColumnName</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (System.Data.DataRow row in Model.Rows)
                {
                    <tr>
                        @foreach (System.Data.DataColumn col in Model.Columns)
                        {
                            var value = row[col] ?? "";
                            string cls = "text-left";

                            if (col.DataType == typeof(DateTime))
                            {
                                value = row[col] != DBNull.Value
                                    ? ((DateTime)row[col]).ToString("dd-MM-yyyy")
                                    : "";
                                cls = "text-right";
                            }
                            else if (
                                col.DataType == typeof(decimal) ||
                                col.DataType == typeof(double) ||
                                col.DataType == typeof(float))
                            {
                                value = row[col] != DBNull.Value
                                    ? string.Format("{0:N2}", row[col])
                                    : "0.00";
                                cls = "text-right";
                            }
                            else if (
                                col.DataType == typeof(int) ||
                                col.DataType == typeof(long))
                            {
                                value = row[col] != DBNull.Value
                                    ? row[col].ToString()
                                    : "0";
                                cls = "text-right";
                            }

                            <td class="@cls">@value</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

    @section scripts {

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

        <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

        <script>
$(document).ready(function () {
    $("#loadingSpinner").show();
    $("#tableContainer").hide();
    var company = @Html.Raw(Json.Encode(ViewBag.Company ?? new {}));

    var table = $('#previewTable').DataTable({
        dom: '<"row mb-2"<"col-md-6"B><"col-md-6 text-end"f>>rtip',
        //scrollX: true,
        //pageLength: 10,
        //ordering: true,
        //searching: true,
        scrollX: true,
        scrollCollapse: true,
        autoWidth: false,
        fixedHeader: true,
        pageLength: 10,
        ordering: true,
        searching: true,
        responsive: false,
        buttons: [

            {
                extend: 'excelHtml5',
                text: '<i class="fa-solid fa-file-excel"></i> Excel',
                className: 'export-btn excel-btn'
            },

            {
                extend: 'pdfHtml5',
                text: '<i class="fa-solid fa-file-pdf"></i> PDF',
                className: 'export-btn pdf-btn',
                orientation: 'landscape',
                pageSize: 'A4',

                customize: function (doc) {

                    var companyName = company.CompnyName || '';
                    var address = company.Address || '';
                    var contact =
                        (company.Phone ? 'Tel: ' + company.Phone : '') +
                        (company.Email ? ' | Email: ' + company.Email : '');

                    doc.content.splice(0, 1);

                    doc.content.unshift({
                        margin: [0, 0, 0, 10],
                        alignment: 'center',
                        stack: [
                            { text: companyName, fontSize: 16, bold: true },
                            { text: address, fontSize: 9 },
                            { text: contact, fontSize: 9 },
                            { text: 'Report Preview', margin: [0, 8, 0, 0], bold: true }
                        ]
                    });

                    doc.footer = function (page, pages) {
                        return {
                            columns: [
                                { text: 'Generated from 10X Manager Portal', alignment: 'left', fontSize: 8 },
                                { text: 'Page ' + page + ' of ' + pages, alignment: 'right', fontSize: 8 }
                            ],
                            margin: [30, 10]
                        };
                    };

                    doc.pageMargins = [30, 80, 30, 50];

                    var body = doc.content[doc.content.length - 1].table.body;
                    for (var i = 1; i < body.length; i++) {
                        for (var j = 0; j < body[i].length; j++) {
                            if (!isNaN(body[i][j].text)) {
                                body[i][j].alignment = 'right';
                            }
                        }
                    }
                }
            },

            {
                extend: 'print',
                text: '<i class="fa-solid fa-print"></i> Print',
                className: 'export-btn print-btn',

                customize: function (win) {

                    $(win.document.body).find('h1').remove();

                    $(win.document.body).prepend(
                        '<div style="text-align:center;">' +
                            '<h2>' + (company.CompnyName || '') + '</h2>' +
                            '<p>' + (company.Address || '') + '</p>' +
                            '<p>' + (company.Phone || '') + ' ' + (company.Email || '') + '</p>' +
                            '<hr />' +
                            '<h4>Report Preview</h4>' +
                        '</div>'
                    );

                    $(win.document.body).append(
                        '<div style="position:fixed;bottom:0;width:100%;text-align:center;font-size:11px;">' +
                            '<hr />Generated from 10X Manager Portal</div>'
                    );

                    $(win.document.body).find('td').each(function () {
                        if (!isNaN($(this).text()) && $(this).text().trim() !== '') {
                            $(this).css('text-align', 'right');
                        }
                    });
                }
            },
                  {
                extend: 'collection',
                text: '<i class="fa-solid fa-share-nodes"></i> Share',
                className: 'export-btn btn-outline-secondary',
                autoClose: true,
                buttons: [
                    {
                        text: '<i class="fa-brands fa-whatsapp text-success"></i> WhatsApp',
                        action: function () {
                            window.open(
                                `https://wa.me/?text=${encodeURIComponent(window.location.href)}`,
                                '_blank'
                            );
                        }
                    },
                    {
                        text: '<i class="fa-solid fa-envelope text-danger"></i> Email',
                        action: function () {
                            window.location.href =
                                `mailto:?subject=Notifications Report&body=${encodeURIComponent(window.location.href)}`;
                        }
                    },
                    {
                        text: '<i class="fa-solid fa-link"></i> Copy Link',
                        action: function () {
                            navigator.clipboard.writeText(window.location.href);
                            alert('Link copied');
                        }
                    }
                ]
            }
        ],

        initComplete: function () {
            $("#loadingSpinner").fadeOut(300);
            $("#tableContainer").fadeIn(300);
        }
    });
    table.columns.adjust().draw();
    $(window).on('resize', function () {
        table.columns.adjust();
    });
});
        </script>
    }

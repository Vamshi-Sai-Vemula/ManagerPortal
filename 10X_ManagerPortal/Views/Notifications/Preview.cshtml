@model System.Data.DataTable

@{
    ViewBag.Title = "Notifications Preview";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
    table.dataTable {
        width: 100%;
        border-collapse: collapse;
    }

        table.dataTable th, table.dataTable td {
            padding: 6px;
            white-space: nowrap;
            border: 1px solid #ddd;
        }

        table.dataTable thead th {
            background: #e6e6e6;
            color: #333;
            text-align: center;
        }

    .text-left {
        text-align: left !important;
    }

    .text-right {
        text-align: right !important;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .export-btn {
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 4px;
    }

    .excel-btn {
        border: 1px solid #4caf50;
        color: #2e7d32;
    }

    .pdf-btn {
        border: 1px solid #e53935;
        color: #b71c1c;
    }

    .print-btn {
        border: 1px solid #424242;
        color: #424242;
    }
</style>
<div id="loadingSpinner" class="text-center p-5">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-danger"></i>
        <p class="mt-2 fw-semibold">Loading report, please wait...</p>
    </div>
<div class="card shadow border border-primary p-3 mt-4">
    <!-- LOADING -->
    
    <div class="preview-header">
        <div>
            <h4 class="mb-1">Notifications Preview</h4>
            <p class="text-muted mb-0">Notification results</p>
        </div>
        <a href="@Url.Action("Index", "Notifications")" class="btn btn-outline-primary">← Back</a>


    </div>
    <!-- TABLE -->
    <div id="tableContainer" style="display:none;">

        <table id="previewTable" class="display nowrap" cellspacing="0">
            <thead>
                <tr>
                    @foreach (System.Data.DataColumn col in Model.Columns)
                    {
                        <th>@col.ColumnName</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (System.Data.DataRow row in Model.Rows)
                {
                    <tr>
                        @foreach (System.Data.DataColumn col in Model.Columns)
                        {
                            var value = row[col] ?? "";
                            string cellClass = "text-left";

                            if (col.DataType == typeof(DateTime))
                            {
                                value = row[col] != DBNull.Value ? ((DateTime)row[col]).ToString("dd-MM-yyyy") : "";
                                cellClass = "text-right";
                            }
                            else if (col.DataType == typeof(decimal) || col.DataType == typeof(double) || col.DataType == typeof(float))
                            {
                                value = row[col] != DBNull.Value ? string.Format("{0:N2}", row[col]) : "0.00";
                                cellClass = "text-right";
                            }
                            else if (col.DataType == typeof(int) || col.DataType == typeof(long))
                            {
                                value = row[col] != DBNull.Value ? row[col].ToString() : "0";
                                cellClass = "text-right";
                            }

                            <td class="@cellClass">@value</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
    </div>
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Share Report</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">

                    <button class="btn btn-success w-100 mb-2" id="shareWhatsapp">
                        <i class="fa-brands fa-whatsapp"></i> WhatsApp
                    </button>

                    <button class="btn btn-danger w-100 mb-2" id="shareEmail">
                        <i class="fa-solid fa-envelope"></i> Gmail / Email
                    </button>

                    <button class="btn btn-secondary w-100" id="copyLink">
                        <i class="fa-solid fa-link"></i> Copy Link
                    </button>

                </div>
            </div>
        </div>
    </div>


    @section scripts {

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

        <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

        <script>
$(document).ready(function () {
    $("#loadingSpinner").show();
    $("#tableContainer").hide();
    var company = @Html.Raw(Json.Encode(ViewBag.Company ?? new {}));

    var table=$('#previewTable').DataTable({
        dom: '<"row mb-2"<"col-md-6"B><"col-md-6 text-end"f>>rtip',
        //scrollX: true,
        //pageLength: 10,
        //ordering: true,
        //searching: true,
        scrollX: true,
        scrollCollapse: true,
        autoWidth: false,
        fixedHeader: true,
        pageLength: 10,
        ordering: true,
        searching: true,
        responsive: false,

        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fa-solid fa-file-excel"></i> Excel',
                className: 'export-btn excel-btn'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fa-solid fa-file-pdf"></i> PDF',
                className: 'export-btn pdf-btn',
                orientation: 'landscape',
                pageSize: 'A4',
                customize: function (doc) {
                    var companyName = company.CompnyName || '';
                    var address = company.Address || '';
                    var contact = (company.Phone ? 'Tel: ' + company.Phone : '') +
                                  (company.Email ? ' | Email: ' + company.Email : '');

                    doc.content.splice(0, 1); // remove default title

                    doc.content.unshift({
                        margin: [0, 0, 0, 10],
                        alignment: 'center',
                        stack: [
                            { text: companyName, fontSize: 16, bold: true },
                            { text: address, fontSize: 9 },
                            { text: contact, fontSize: 9 },
                            { text: 'Notifications Report', margin: [0,8,0,0], bold: true }
                        ]
                    });

                    doc.footer = function (page, pages) {
                        return {
                            columns: [
                                { text: 'Generated from 10X Manager Portal', alignment: 'left', fontSize: 8 },
                                { text: 'Page ' + page + ' of ' + pages, alignment: 'right', fontSize: 8 }
                            ],
                            margin: [30,10]
                        };
                    };

                    doc.pageMargins = [30,80,30,50];

                    // Right align numeric columns in PDF
                    var body = doc.content[doc.content.length - 1].table.body;
                    for (var i = 1; i < body.length; i++) {
                        for (var j = 0; j < body[i].length; j++) {
                            var cell = body[i][j];
                            if (!isNaN(parseFloat(cell.text))) cell.alignment = 'right';
                        }
                    }
                }
            },
            {
                extend: 'print',
                text: '<i class="fa-solid fa-print"></i> Print',
                className: 'export-btn print-btn',
                customize: function (win) {
                    $(win.document.body).find('h1').remove();

                    $(win.document.body).prepend(
                        '<div style="text-align:center;">' +
                            '<h2>' + company.CompnyName + '</h2>' +
                            '<p>' + company.Address + '</p>' +
                            '<p>' + (company.Phone || '') + ' ' + (company.Email || '') + '</p>' +
                            '<hr />' +
                            '<h4>Notifications Report</h4>' +
                        '</div>'
                    );

                    $(win.document.body).append(
                        '<div style="position:fixed; bottom:0; width:100%; text-align:center; font-size:11px;">' +
                            '<hr />Generated from 10X Manager Portal</div>'
                    );

                    // Right align numeric columns in print
                    $(win.document.body).find('td').each(function() {
                        var val = $(this).text();
                        if(!isNaN(val) && val.trim() !== '') $(this).css('text-align','right');
                    });
                }
            },
            // ✅ SHARE DROPDOWN
            {
                extend: 'collection',
                text: '<i class="fa-solid fa-share-nodes"></i> Share',
                className: 'export-btn btn-outline-secondary',
                autoClose: true,
                buttons: [
                    {
                        text: '<i class="fa-brands fa-whatsapp text-success"></i> WhatsApp',
                        action: function () {
                            window.open(
                                `https://wa.me/?text=${encodeURIComponent(window.location.href)}`,
                                '_blank'
                            );
                        }
                    },
                    {
                        text: '<i class="fa-solid fa-envelope text-danger"></i> Email',
                        action: function () {
                            window.location.href =
                                `mailto:?subject=Notifications Report&body=${encodeURIComponent(window.location.href)}`;
                        }
                    },
                    {
                        text: '<i class="fa-solid fa-link"></i> Copy Link',
                        action: function () {
                            navigator.clipboard.writeText(window.location.href);
                            alert('Link copied');
                        }
                    }
                ]
            }

            //{
            //    text: '<i class="fa-solid fa-share-nodes"></i> Share',
            //    className: 'export-btn btn-outline-secondary',
            //    action: function () {
            //        $('#shareModal').modal('show');
            //    }
            //}
        ],
        initComplete: function () {
            // ensure proper column sizing
            this.api().columns.adjust();

            $("#loadingSpinner").fadeOut(300);
            $("#tableContainer").fadeIn(300);
        },
        columnDefs: [
            {
                targets: "_all",
                render: function (data, type) {

                    if (type === 'display' && $.isNumeric(data)) {
                        var num = Number(data);

                        // integer → no decimals
                        if (Number.isInteger(num)) {
                            return '<div style="text-align:right">' + num + '</div>';
                        }

                        // decimal → 2 decimals
                        return '<div style="text-align:right">' + num.toFixed(2) + '</div>';
                    }

                    // date handling
                    if (type === 'display' && Date.parse(data)) {
                        return '<div style="text-align:right">' +
                            new Date(data).toLocaleDateString('en-GB') +
                            '</div>';
                    }

                    return data;
                }
            }
        ]


        //columnDefs: [
        //    {
        //        targets: "_all",
        //        render: function (data, type, row, meta) {
        //            if (type === 'display') {
        //                if ($.isNumeric(data)) return '<div style="text-align:right">' + parseFloat(data).toFixed(2) + '</div>';
        //                if (Date.parse(data)) return '<div style="text-align:right">' + new Date(data).toLocaleDateString('en-GB') + '</div>';
        //            }
        //            return data;
        //        }
        //    }
        //]
    });
    table.columns.adjust().draw();
    $(window).on('resize', function () {
        table.columns.adjust();
    });

});

        </script>
        <script>
            $(function () {

                function getShareText() {
                    return encodeURIComponent(
                        "Notifications Report\n" +
                        "Company: " + (company.CompnyName || '') + "\n" +
                        window.location.href
                    );
                }

                $('#shareWhatsapp').click(function () {
                    window.open('https://wa.me/?text=' + getShareText(), '_blank');
                });

                $('#shareEmail').click(function () {
                    window.location.href =
                        'mailto:?subject=Notifications Report&body=' + getShareText();
                });

                $('#copyLink').click(function () {
                    navigator.clipboard.writeText(window.location.href)
                        .then(() => alert('Link copied'));
                });

            });
        </script>

        @*<script>
                $(function () {

                    function getShareText() {
                        return encodeURIComponent(
                            "Notifications Report\n" +
                            "Company: " + (company.CompnyName || '') + "\n" +
                            "View here: " + window.location.href
                        );
                    }

                    // WhatsApp Share
                    $('#shareWhatsapp').click(function (e) {
                        e.preventDefault();
                        window.open(
                            'https://wa.me/?text=' + getShareText(),
                            '_blank'
                        );
                    });

                    // Gmail / Email Share
                    $('#shareEmail').click(function (e) {
                        e.preventDefault();
                        window.location.href =
                            'mailto:?subject=Notifications Report&body=' + getShareText();
                    });

                    // Copy Link
                    $('#copyLink').click(function (e) {
                        e.preventDefault();
                        navigator.clipboard.writeText(window.location.href)
                            .then(() => alert('Link copied to clipboard'));
                    });

                });
            </script>*@

    }
